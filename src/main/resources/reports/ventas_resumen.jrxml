<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="ventas_resumen"
              pageWidth="595" pageHeight="842"
              columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">

    <parameter name="P_FECHA_INI"  class="java.util.Date"/>
    <parameter name="P_FECHA_FIN"  class="java.util.Date"/>
    <parameter name="P_CLIENTE_ID" class="java.lang.Long"/>

    <queryString>
        <![CDATA[
SELECT  f.fecha,
        c.nombre                    AS cliente,
        SUM(d.cantidad)             AS cant_items,
        SUM(d.cantidad*d.precio_unit) AS total
FROM factura f
JOIN pedido      p ON p.id = f.pedido_id
JOIN pedido_det  d ON d.pedido_id = p.id
JOIN clientes    c ON c.id = p.cliente_id
WHERE f.fecha BETWEEN $P{P_FECHA_INI} AND $P{P_FECHA_FIN}
  AND ( $P{P_CLIENTE_ID} IS NULL OR p.cliente_id = $P{P_CLIENTE_ID} )
GROUP BY f.fecha, c.nombre
ORDER BY f.fecha, c.nombre
        ]]>
    </queryString>

    <field name="fecha"       class="java.sql.Date"/>
    <field name="cliente"     class="java.lang.String"/>
    <field name="cant_items"  class="java.lang.Long"/>
    <field name="total"       class="java.math.BigDecimal"/>

    <title>
        <band height="36">
            <textField>
                <reportElement x="0" y="0" width="555" height="18"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA["VENTAS â€” RESUMEN"]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="0" y="18" width="555" height="18"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA[
"Rango: "
+ new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_INI})
+ " a "
+ new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_FIN})
                ]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <columnHeader>
        <band height="16">
            <staticText><reportElement x="0"   y="0" width="90"  height="16"/><text><![CDATA[Fecha]]></text></staticText>
            <staticText><reportElement x="90"  y="0" width="260" height="16"/><text><![CDATA[Cliente]]></text></staticText>
            <staticText><reportElement x="350" y="0" width="90"  height="16"/><text><![CDATA[Items]]></text></staticText>
            <staticText><reportElement x="440" y="0" width="115" height="16"/><text><![CDATA[Total]]></text></staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="16">
            <textField><reportElement x="0"   y="0" width="90"  height="16"/>
                <textFieldExpression><![CDATA[new java.text.SimpleDateFormat("yyyy-MM-dd").format($F{fecha})]]></textFieldExpression>
            </textField>
            <textField><reportElement x="90"  y="0" width="260" height="16"/><textFieldExpression><![CDATA[$F{cliente}]]></textFieldExpression></textField>
            <textField><reportElement x="350" y="0" width="90"  height="16"/><textFieldExpression><![CDATA[$F{cant_items}]]></textFieldExpression></textField>
            <textField><reportElement x="440" y="0" width="115" height="16"/><textFieldExpression><![CDATA[$F{total}]]></textFieldExpression></textField>
        </band>
    </detail>
</jasperReport>
