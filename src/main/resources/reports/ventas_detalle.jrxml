<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="ventas_detalle"
              pageWidth="595" pageHeight="842"
              columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">

    <!-- Parámetros requeridos -->
    <parameter name="P_FECHA_INI"  class="java.util.Date"/>
    <parameter name="P_FECHA_FIN"  class="java.util.Date"/>
    <!-- opcional: si es null no filtra -->
    <parameter name="P_CLIENTE_ID" class="java.lang.Long"/>

    <queryString>
        <![CDATA[
SELECT  f.fecha,
        f.serie, f.numero,
        c.nombre       AS cliente,
        prod.codigo    AS codigo,
        prod.nombre    AS producto,
        d.cantidad     AS cantidad,
        d.precio_unit  AS precio,
        (d.cantidad * d.precio_unit) AS subtotal
FROM factura f
JOIN pedido      p  ON p.id = f.pedido_id
JOIN pedido_det  d  ON d.pedido_id = p.id
JOIN clientes    c  ON c.id = p.cliente_id
JOIN productos   prod ON prod.id = d.producto_id
WHERE f.fecha BETWEEN $P{P_FECHA_INI} AND $P{P_FECHA_FIN}
  AND ( $P{P_CLIENTE_ID} IS NULL OR p.cliente_id = $P{P_CLIENTE_ID} )
ORDER BY f.fecha, f.serie, f.numero, prod.nombre
        ]]>
    </queryString>

    <!-- Campos -->
    <field name="fecha"    class="java.sql.Date"/>
    <field name="serie"    class="java.lang.String"/>
    <field name="numero"   class="java.lang.String"/>
    <field name="cliente"  class="java.lang.String"/>
    <field name="codigo"   class="java.lang.String"/>
    <field name="producto" class="java.lang.String"/>
    <field name="cantidad" class="java.lang.Integer"/>
    <field name="precio"   class="java.math.BigDecimal"/>
    <field name="subtotal" class="java.math.BigDecimal"/>

    <title>
        <band height="36">
            <textField>
                <reportElement x="0" y="0" width="555" height="18"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA["VENTAS — DETALLE"]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="0" y="18" width="555" height="18"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA[
"Rango: "
+ new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_INI})
+ " a "
+ new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_FIN})
                ]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <columnHeader>
        <band height="16">
            <staticText><reportElement x="0"   y="0" width="70"  height="16"/><text><![CDATA[Fecha]]></text></staticText>
            <staticText><reportElement x="70"  y="0" width="50"  height="16"/><text><![CDATA[Serie]]></text></staticText>
            <staticText><reportElement x="120" y="0" width="60"  height="16"/><text><![CDATA[Número]]></text></staticText>
            <staticText><reportElement x="180" y="0" width="110" height="16"/><text><![CDATA[Cliente]]></text></staticText>
            <staticText><reportElement x="290" y="0" width="70"  height="16"/><text><![CDATA[Código]]></text></staticText>
            <staticText><reportElement x="360" y="0" width="100" height="16"/><text><![CDATA[Producto]]></text></staticText>
            <staticText><reportElement x="460" y="0" width="40"  height="16"/><text><![CDATA[Cant.]]></text></staticText>
            <staticText><reportElement x="500" y="0" width="55"  height="16"/><text><![CDATA[Precio]]></text></staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="16">
            <textField><reportElement x="0"   y="0" width="70"  height="16"/>
                <textFieldExpression><![CDATA[new java.text.SimpleDateFormat("yyyy-MM-dd").format($F{fecha})]]></textFieldExpression>
            </textField>
            <textField><reportElement x="70"  y="0" width="50"  height="16"/><textFieldExpression><![CDATA[$F{serie}]]></textFieldExpression></textField>
            <textField><reportElement x="120" y="0" width="60"  height="16"/><textFieldExpression><![CDATA[$F{numero}]]></textFieldExpression></textField>
            <textField><reportElement x="180" y="0" width="110" height="16"/><textFieldExpression><![CDATA[$F{cliente}]]></textFieldExpression></textField>
            <textField><reportElement x="290" y="0" width="70"  height="16"/><textFieldExpression><![CDATA[$F{codigo}]]></textFieldExpression></textField>
            <textField><reportElement x="360" y="0" width="100" height="16"/><textFieldExpression><![CDATA[$F{producto}]]></textFieldExpression></textField>
            <textField><reportElement x="460" y="0" width="40"  height="16"/><textFieldExpression><![CDATA[$F{cantidad}]]></textFieldExpression></textField>
            <textField><reportElement x="500" y="0" width="55"  height="16"/><textFieldExpression><![CDATA[$F{precio}]]></textFieldExpression></textField>
        </band>
    </detail>
</jasperReport>
