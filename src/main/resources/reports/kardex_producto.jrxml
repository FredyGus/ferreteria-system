<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="kardex_producto" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
    <parameter name="P_PRODUCTO_ID" class="java.lang.Long"/>
    <parameter name="P_FECHA_INI" class="java.util.Date"/>
    <parameter name="P_FECHA_FIN" class="java.util.Date"/>
    <queryString>
        <![CDATA[
SELECT x.fecha, x.tipo, x.codigo, x.producto, x.cant_in, x.cant_out
FROM (
  SELECT i.fecha AS fecha, 'INGRESO' AS tipo, prod.codigo, prod.nombre AS producto,
         det.cantidad AS cant_in, 0 AS cant_out
  FROM ingreso i
  JOIN ingreso_det det ON det.ingreso_id = i.id
  JOIN productos prod   ON prod.id = det.producto_id
  WHERE det.producto_id = $P{P_PRODUCTO_ID}
    AND i.fecha BETWEEN $P{P_FECHA_INI} AND $P{P_FECHA_FIN}

  UNION ALL

  SELECT f.fecha AS fecha, 'VENTA' AS tipo, prod.codigo, prod.nombre AS producto,
         0 AS cant_in, d.cantidad AS cant_out
  FROM factura f
  JOIN pedido p     ON p.id = f.pedido_id
  JOIN pedido_det d ON d.pedido_id = p.id
  JOIN productos prod ON prod.id = d.producto_id
  WHERE d.producto_id = $P{P_PRODUCTO_ID}
    AND f.fecha BETWEEN $P{P_FECHA_INI} AND $P{P_FECHA_FIN}
) x
ORDER BY x.fecha
        ]]>
    </queryString>

    <field name="fecha" class="java.sql.Timestamp"/>
    <field name="tipo" class="java.lang.String"/>
    <field name="codigo" class="java.lang.String"/>
    <field name="producto" class="java.lang.String"/>
    <field name="cant_in" class="java.lang.Integer"/>
    <field name="cant_out" class="java.lang.Integer"/>

    <!-- Variable para balance acumulado (ingresos - salidas) -->
    <variable name="BALANCE" class="java.lang.Integer" calculation="System">
        <initialValueExpression><![CDATA[0]]></initialValueExpression>
        <variableExpression><![CDATA[$V{BALANCE} + ($F{cant_in} - $F{cant_out})]]></variableExpression>
    </variable>

    <title>
        <band height="40">
            <textField><reportElement x="0" y="0" width="555" height="20"/><textElement textAlignment="Center"/><textFieldExpression><![CDATA["KÁRDEX POR PRODUCTO"]]></textFieldExpression></textField>
            <textField><reportElement x="0" y="20" width="555" height="20"/><textElement textAlignment="Center"/><textFieldExpression><![CDATA["Rango: " + new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_INI}) + " a " + new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_FIN})]]></textFieldExpression></textField>
        </band>
    </title>

    <columnHeader>
        <band height="16">
            <staticText><reportElement x="0"   y="0" width="90" height="16"/><text><![CDATA[Fecha]]></text></staticText>
            <staticText><reportElement x="90"  y="0" width="80" height="16"/><text><![CDATA[Tipo]]></text></staticText>
            <staticText><reportElement x="170" y="0" width="140" height="16"/><text><![CDATA[Producto]]></text></staticText>
            <staticText><reportElement x="310" y="0" width="70" height="16"/><text><![CDATA[Ingreso]]></text></staticText>
            <staticText><reportElement x="380" y="0" width="70" height="16"/><text><![CDATA[Salida]]></text></staticText>
            <staticText><reportElement x="450" y="0" width="105" height="16"/><text><![CDATA[Balance]]></text></staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="16">
            <textField><reportElement x="0" y="0" width="90" height="16"/><textFieldExpression><![CDATA[new java.text.SimpleDateFormat("yyyy-MM-dd").format($F{fecha})]]></textFieldExpression></textField>
            <textField><reportElement x="90" y="0" width="80" height="16"/><textFieldExpression><![CDATA[$F{tipo}]]></textFieldExpression></textField>
            <textField><reportElement x="170" y="0" width="140" height="16"/><textFieldExpression><![CDATA[$F{codigo} + " - " + $F{producto}]]></textFieldExpression></textField>
            <textField><reportElement x="310" y="0" width="70" height="16"/><textFieldExpression><![CDATA[$F{cant_in}]]></textFieldExpression></textField>
            <textField><reportElement x="380" y="0" width="70" height="16"/><textFieldExpression><![CDATA[$F{cant_out}]]></textFieldExpression></textField>
            <textField><reportElement x="450" y="0" width="105" height="16"/><textFieldExpression><![CDATA[$V{BALANCE}]]></textFieldExpression></textField>
        </band>
    </detail>
</jasperReport>
