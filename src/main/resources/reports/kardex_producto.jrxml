<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="kardex_producto"
              pageWidth="595" pageHeight="842"
              columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">

    <!-- Parámetros (DATE inclusivo) -->
    <parameter name="P_PRODUCTO_ID" class="java.lang.Long"/>
    <parameter name="P_FECHA_INI"   class="java.util.Date"/>
    <parameter name="P_FECHA_FIN"   class="java.util.Date"/>

    <!--
      NOTA CLAVE:
      - En las condiciones se usa DATE(columna) para agrupar por día aunque la columna sea DATETIME.
      - El SALDO INICIAL se calcula con movimientos ANTERIORES al día 'desde'
        y se inserta como una fila "SALDO INICIAL" sumando al acumulado.
    -->
    <queryString>
        <![CDATA[
SELECT t.fecha,
       t.tipo,
       t.codigo,
       t.producto,
       t.cant_in,
       t.cant_out
FROM (
    /* --------- SALDO INICIAL (antes de P_FECHA_INI) --------- */
    SELECT
        $P{P_FECHA_INI}     AS fecha,
        'SALDO INICIAL'     AS tipo,
        p.codigo            AS codigo,
        p.nombre            AS producto,
        /* cant_in lleva el saldo para que el acumulado arranque correctamente */
        (
          /* ingresos antes del día 'desde' */
          (SELECT COALESCE(SUM(idet.cantidad),0)
             FROM ingreso i
             JOIN ingreso_det idet ON idet.ingreso_id = i.id
            WHERE idet.producto_id = $P{P_PRODUCTO_ID}
              AND DATE(i.fecha)   < DATE($P{P_FECHA_INI})
          )
          -
          /* ventas antes del día 'desde' */
          (SELECT COALESCE(SUM(pdet.cantidad),0)
             FROM factura f
             JOIN pedido      ped  ON ped.id = f.pedido_id
             JOIN pedido_det  pdet ON pdet.pedido_id = ped.id
            WHERE pdet.producto_id = $P{P_PRODUCTO_ID}
              AND DATE(f.fecha)    < DATE($P{P_FECHA_INI})
          )
        ) AS cant_in,
        0 AS cant_out
    FROM productos p
    WHERE p.id = $P{P_PRODUCTO_ID}

    UNION ALL

    /* ---------------- Movimientos dentro del rango ---------------- */

    /* Ingresos del día/rango (si tu columna es DATETIME, usar DATE(i.fecha)) */
    SELECT
        DATE(i.fecha)         AS fecha,
        'INGRESO'             AS tipo,
        p.codigo              AS codigo,
        p.nombre              AS producto,
        idet.cantidad         AS cant_in,
        0                     AS cant_out
    FROM ingreso i
    JOIN ingreso_det idet ON idet.ingreso_id = i.id
    JOIN productos   p    ON p.id = idet.producto_id
    WHERE idet.producto_id = $P{P_PRODUCTO_ID}
      AND DATE(i.fecha) BETWEEN DATE($P{P_FECHA_INI}) AND DATE($P{P_FECHA_FIN})

    UNION ALL

    /* Ventas del día/rango */
    SELECT
        DATE(f.fecha)         AS fecha,
        'VENTA'               AS tipo,
        p.codigo              AS codigo,
        p.nombre              AS producto,
        0                     AS cant_in,
        pdet.cantidad         AS cant_out
    FROM factura f
    JOIN pedido      ped  ON ped.id = f.pedido_id
    JOIN pedido_det  pdet ON pdet.pedido_id = ped.id
    JOIN productos   p    ON p.id = pdet.producto_id
    WHERE pdet.producto_id = $P{P_PRODUCTO_ID}
      AND DATE(f.fecha) BETWEEN DATE($P{P_FECHA_INI}) AND DATE($P{P_FECHA_FIN})
) t
ORDER BY t.fecha, t.tipo
        ]]>
    </queryString>

    <!-- Campos -->
    <field name="fecha"    class="java.sql.Date"/>
    <field name="tipo"     class="java.lang.String"/>
    <field name="codigo"   class="java.lang.String"/>
    <field name="producto" class="java.lang.String"/>
    <field name="cant_in"  class="java.lang.Integer"/>
    <field name="cant_out" class="java.lang.Integer"/>

    <!-- Variables acumuladas (balance = ingresos - salidas, incluyendo el saldo inicial) -->
    <variable name="SUM_IN" class="java.lang.Integer" calculation="Sum">
        <variableExpression><![CDATA[$F{cant_in} == null ? 0 : $F{cant_in}]]></variableExpression>
    </variable>
    <variable name="SUM_OUT" class="java.lang.Integer" calculation="Sum">
        <variableExpression><![CDATA[$F{cant_out} == null ? 0 : $F{cant_out}]]></variableExpression>
    </variable>
    <variable name="BALANCE" class="java.lang.Integer" calculation="Nothing">
        <variableExpression><![CDATA[$V{SUM_IN} - $V{SUM_OUT}]]></variableExpression>
    </variable>

    <title>
        <band height="40">
            <textField>
                <reportElement x="0" y="0" width="555" height="20"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA["KÁRDEX POR PRODUCTO"]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="0" y="20" width="555" height="20"/>
                <textElement textAlignment="Center"/>
                <textFieldExpression><![CDATA[
"Rango: "
+ new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_INI})
+ " a "
+ new java.text.SimpleDateFormat("yyyy-MM-dd").format($P{P_FECHA_FIN})
                ]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <columnHeader>
        <band height="16">
            <staticText><reportElement x="0"   y="0" width="90"  height="16"/><text><![CDATA[Fecha]]></text></staticText>
            <staticText><reportElement x="90"  y="0" width="100" height="16"/><text><![CDATA[Tipo]]></text></staticText>
            <staticText><reportElement x="190" y="0" width="140" height="16"/><text><![CDATA[Producto]]></text></staticText>
            <staticText><reportElement x="330" y="0" width="70"  height="16"/><text><![CDATA[Ingreso]]></text></staticText>
            <staticText><reportElement x="400" y="0" width="70"  height="16"/><text><![CDATA[Salida]]></text></staticText>
            <staticText><reportElement x="470" y="0" width="85"  height="16"/><text><![CDATA[Balance]]></text></staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="16">
            <textField>
                <reportElement x="0" y="0" width="90" height="16"/>
                <textFieldExpression><![CDATA[
new java.text.SimpleDateFormat("yyyy-MM-dd").format($F{fecha})
                ]]></textFieldExpression>
            </textField>
            <textField><reportElement x="90"  y="0" width="100" height="16"/>
                <textFieldExpression><![CDATA[$F{tipo}]]></textFieldExpression>
            </textField>
            <textField><reportElement x="190" y="0" width="140" height="16"/>
                <textFieldExpression><![CDATA[$F{codigo} + " - " + $F{producto}]]></textFieldExpression>
            </textField>
            <textField><reportElement x="330" y="0" width="70" height="16"/>
                <textFieldExpression><![CDATA[$F{cant_in}]]></textFieldExpression>
            </textField>
            <textField><reportElement x="400" y="0" width="70" height="16"/>
                <textFieldExpression><![CDATA[$F{cant_out}]]></textFieldExpression>
            </textField>
            <textField><reportElement x="470" y="0" width="85" height="16"/>
                <textFieldExpression><![CDATA[$V{BALANCE}]]></textFieldExpression>
            </textField>
        </band>
    </detail>
</jasperReport>
